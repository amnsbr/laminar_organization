# Organization of laminar thickness covariance in the human cortex

This repository includes data and code associated with the paper "Organization of laminar thickness covariance in the human cortex", Saberi et al.

## Repository structure
- Source files are located in `src/`. The README in this folder lists a short description and the origin of each source file.
- The analyses are done via files in `code/`
    - `setup.sh` creates the virtual environment and installs dependencies based on `enviornment.yml`
    - `run_figures.sh` executes the Jupyter notebook files included in this folder which will output the figures reported in main text (`Fig_ltcg.ipynb`, `Fig_hierarchy.ipynb`, `Fig_connectivity.ipynb` and `Fig_development.ipynb`) as well as the supplements (`Fig_S_ltcg.ipynb`, `Fig_S_hierarchy.ipynb`, `Fig_S_connectivity.ipynb`). Note that parts of these scripts are very computational intensive. So it is recommended to run it on high-performance computing clusters.
    - The notebooks mainly act as interfaces and use functions/classes defined in the Python files, which include:
        - `datasets.py`: Functions needed to load and preprocess the source data from `src` or external packages.
        - `matrices.py`: Includes a generic class `Matrix` with functions for matrix plotting and matrix-level associations. It also includes several classes for each type of the matrix used in this study, such as `MicrostructuralCovarianceMatrix` (which can create LTC, LDC, MPC and fused LTC-LDC matrices), `ConnectivityMatrix` (which loads structural, functional and effective connectivity matrices) and `StructuralCovarianceMatrix`.
        - `surfaces.py`: Includes generic classes `CorticalSurface` and its children `ContCorticalSurface` (continuous data) and `CatCorticalSurface` (categorical data), which include functions for surface plotting and surface-level associations. It also includes several classes for each specific type of the surface data used in this study, such as `Gradients` and `MicrostructuralCovarianceGradients` (which create the gradients), `EffectiveConnectivityMaps` (which creates asymmetry-based hierarchy map) and `MacaqueHierarchy` (which loads macaque laminar-based hierarchy map).
        - `helpers.py`: Includes helper functions for data manipulation (parcellation/deparcellation, down-/upsampling), statistical analysis (spin and variogram permutation), plotting surfaces/matrices, and transforms (e.g., human to macaque mapping).
    - `local/` contains codes that cannot easily be included in the pipeline (`run_figures.sh`) because of their dependencies (e.g. Matlab, FreeSurfer or docker/singularity containers). However the output of these codes are included in the `src` folder and used in the main script.
    - `htcondor/` contains HTCondor `.submit` files to run the scripts (and importantly the `run_figures.sh` script) on high performance computing clusters. If you plan to use these remember to modify the paths to the project folder accordingly.
- The output figures/statistics generated by code are mainly displayed in the Jupyter notebooks. But part of the code also saves some ouput in the subfolder `output` (which is created by the script), which also includes several subfolders for each type of data.

## External dependencies
The Python dependencies are installed by `setup.sh`, but in addition to those the main scripts have the following dependencies that need to be installed manually:
- [Conda](https://docs.conda.io/en/latest/miniconda.html): the version used here was 4.12.0
- [Connectome Workbench](https://www.humanconnectome.org/software/get-connectome-workbench): the version used here was 1.5
- [BigBrainWarp](https://bigbrainwarp.readthedocs.io/en/latest/pages/installation.html) as a singularity image (needed for the function `surface_to_surface_transformation` in `helpers.py` which is used for transformation of LTC G1 from bigbrain space to macaque space). This can be created by running `singularity build bigbrainwarp.simg docker://caseypaquola/bigbrainwarp:latest`.

Each of the scripts in `code/local` have their own specific dependencies, including CIVET 2.1.1 as singularity image (for creating density profiles), Freesurfer 7.1 (for inflating bigbrain surface) and MATLAB R2021b (for downsampling BigBrain and projecting fsaverage annot files to MNI space).

## Support
Feel free to post an issue or contact me (amnsbr\[at\]gmail.com, a.saberi\[at\]fz-juelich.de) if you have any questions or there are any problems with the code.